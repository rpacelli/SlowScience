<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign the Slow Science Manifesto - Institution</title>
    <link rel="stylesheet" href="styles_secondary.css">
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">← Back to Slow Science Movement</a>
        
        <h1>Sign the Slow Science Manifesto - Institution</h1>
        <p class="subtitle">Sign on behalf of your institution, journal, or organization</p>
        
        <div id="successMessage" class="success-message">
            <h3>Thank you for signing!</h3>
            <p>Your institutional signature has been recorded. You'll receive a confirmation email shortly.</p>
            <a href="../index.html">Return to main page</a>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Submitting your signature...</p>
        </div>
        
        <form id="institutionForm" class="form-container">
            <div class="form-group">
                <label for="institutionName" class="required">Institution, journal, or organization</label>
                <div class="help-text">Full name of organization that will be displayed in signatory page. If you would like to include an abbreviation, write the full name followed by the abbreviation in parenthesis. For journals: write the name of the journal, not of the publisher.</div>
                <input type="text" id="institutionName" name="institutionName" required>
                <div class="error-message" id="institutionNameError">Please enter the institution name</div>
            </div>
            
            <div class="form-group">
                <label for="country" class="required">Country</label>
                <select id="country" name="country" required>
                </select>
                <div class="error-message" id="countryError">Please select your country</div>
            </div>

            <div class="form-group">
                <label for="firstName" class="required">First Name(s)</label>
                <input type="text" id="firstName" name="firstName" required>
                <div class="error-message" id="firstNameError">Please enter your first name</div>
            </div>
            
            <div class="form-group">
                <label for="lastName" class="required">Last Name(s)</label>
                <input type="text" id="lastName" name="lastName" required>
                <div class="error-message" id="lastNameError">Please enter your last name</div>
            </div>
            
            <div class="form-group">
                <label for="jobTitle" class="required">Job Title</label>
                <div class="help-text">Requires individuals signing for an organization hold a senior position such as Director, CEO, Editor-in-Chief, etc.</div>
                <input type="text" id="jobTitle" name="jobTitle" required>
                <div class="error-message" id="jobTitleError">Please enter your job title</div>
            </div>
            
            <div class="form-group">
                <label for="email" class="required">Institutional Email</label>
                <input type="email" id="email" name="email" required>
                <div class="error-message" id="emailError">Please enter a valid institutional email</div>
            </div>
            
            <div class="form-group">
                <label for="verificationLink" class="required">Institutional staff page or ORCID</label>
                <div class="help-text">Please provide a link to your staff page or your ORCID verifying your role in your organization.</div>
                <input type="url" id="verificationLink" name="verificationLink" required placeholder="https://">
                <div class="error-message" id="verificationLinkError">Please provide a verification link</div>
            </div>
            
            <div class="form-group">
                <label for="endorsementLink" class="required">Public endorsement statement link</label>
                <div class="help-text">Provide a link to institutional public endorsement statement. This should be a link to your public commitment to responsible research assessment.</div>
                <input type="url" id="endorsementLink" name="endorsementLink" required placeholder="https://">
                <div class="error-message" id="endorsementLinkError">Please provide a public endorsement link</div>
            </div>
            
            <div class="form-group">
                <label for="additionalInfo">Public Statement Additional Details</label>
                <div class="help-text">Provide further information about your public statement endorsing responsible research assessment, if needed.</div>
                <textarea id="additionalInfo" name="additionalInfo" rows="4"></textarea>
            </div>

            <!-- CAPTCHA Section -->
            <div class="captcha-container">
                <label for="captchaInput" class="required">Human Verification</label>
                <div class="captcha-text" id="captchaText">ABCD</div>
                <input type="text" id="captchaInput" placeholder="Enter the text above" required>
                <button type="button" class="captcha-refresh" id="refreshCaptcha">↻ Refresh CAPTCHA</button>
                <div class="error-message" id="captchaError">Please enter the correct CAPTCHA text</div>
            </div>

            <div class="checkbox-group">
                <h3>Declaration and Consent</h3>
                <p>By checking this box, you can proceed to sign the Slow Science Manifesto and understand that you are agreeing that:</p>
                
                <div class="checkbox-item">
                    <input type="checkbox" id="declaration1" name="declaration1" required>
                    <label for="declaration1">
                        I am the person whose name is entered above.
                        By signing on behalf of my organization, I confirm that I have the authority to do so.
                    </label>
                </div>
                
                <div class="checkbox-item">
                    <input type="checkbox" id="declaration2" name="declaration2" required>
                    <label for="declaration2">I give my consent to the Slow Science Movement to publicly display my organization's name and country and my name and job title on the Slow Science website.</label>
                </div>
                
                <div class="checkbox-item">
                    <input type="checkbox" id="declaration3" name="declaration3">
                    <label for="declaration3">
                        <div> <strong> I want to become an active member of the Slow Science Movement. </strong> <br> As an active member, you can have a direct say in our direction by attending meetings and voting on future initiatives. </div>
                        <div class="subscription-email" id="subscriptionEmailContainer">
                            <label for="subscriptionEmail" style="font-weight: normal; margin-top: 10px;">
                                Email for future communication as active member (optional, different from above):
                            </label>
                            <input type="email" id="subscriptionEmail" name="subscriptionEmail" placeholder="Enter email">
                            <div class="error-message" id="subscriptionEmailError">Please enter a valid email address</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <button type="submit" class="btn" id="submitBtn">Sign on Behalf of Institution</button>
        </form>
    </div>

<script>
    // Replace this with your Google Apps Script Web App API URL write_institutions, active members
    const INSTITUTION_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyYX6Y0kBGGOMbutCygXtMU7IHk2ct-l6I-Nq6HoRENw2VCDS6Eslkh5lOXR0BxnfT8UA/exec';
    const MAILING_LIST_URL = "https://script.google.com/macros/s/AKfycbxMontSna_MB0NdmlF_fnczvy8CwXSgunpWIsnA53Bp56OEeVf_6RDRgzPeXgnO-zD85w/exec"
    const ACTIVE_MEMBERS_URL = "https://script.google.com/macros/s/AKfycbzIPJBza3DVROL-mh3oul3Qc2X25V83sAYweYGmu-XWIo9Kw5MuJn19jfiSDJMf6daz/exec"

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadCountries();
        displayCaptcha();
        
        // Wire up CAPTCHA refresh button
        document.getElementById('refreshCaptcha').addEventListener('click', displayCaptcha);
        
        // Toggle subscription email field
        document.getElementById('declaration3').addEventListener('change', function() {
            const emailContainer = document.getElementById('subscriptionEmailContainer');
            if (this.checked) {
                emailContainer.classList.add('active');
                // Pre-fill with institutional email if empty
                const subscriptionEmailField = document.getElementById('subscriptionEmail');
                const institutionalEmail = document.getElementById('email').value;
                if (!subscriptionEmailField.value.trim() && institutionalEmail) {
                    subscriptionEmailField.value = institutionalEmail;
                }
            } else {
                emailContainer.classList.remove('active');
            }
        });
    });

    // CAPTCHA functions
    function generateCaptcha() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
        let captcha = '';
        for (let i = 0; i < 6; i++) {
            captcha += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        sessionStorage.setItem('captcha', captcha);
        return captcha;
    }

    function displayCaptcha() {
        const captcha = generateCaptcha();
        document.getElementById('captchaText').textContent = captcha;
        document.getElementById('captchaInput').value = '';
        document.getElementById('captchaError').style.display = 'none';
    }

    function validateCaptcha(input) {
        const storedCaptcha = sessionStorage.getItem('captcha');
        if (!storedCaptcha) return false;
        return input.toLowerCase() === storedCaptcha.toLowerCase();
    }    

    // Load countries function
    function loadCountries() {
        const countrySelect = document.getElementById('country');
        
        // First add the default option
        countrySelect.innerHTML = '<option value="">Select your country</option>';
        
        // Try to load from country_list.html
        fetch('country_list.html')
            .then(response => {
                if (!response.ok) {
                    console.error('File not found or inaccessible');
                    throw new Error('Cannot load country list');
                }
                return response.text();
            })
            .then(html => {
                // Just append the cleaned HTML
                countrySelect.innerHTML += html;
                
                console.log('Loaded countries:', countrySelect.options.length - 1);
            })
            .catch(error => {
                console.error('Failed to load countries:', error);
                
                // Use a short fallback list
                const shortList = [
                    "Australia", "Austria", "Belgium", "Brazil", "Canada",
                    "China", "Denmark", "Finland", "France", "Germany",
                    "India", "Ireland", "Italy", "Japan", "Mexico",
                    "Netherlands", "New Zealand", "Norway", "Portugal", "Russia",
                    "South Africa", "South Korea", "Spain", "Sweden", "Switzerland",
                    "United Kingdom (UK)", "United States of America (USA)"
                ].sort();
                
                shortList.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    countrySelect.appendChild(option);
                });
                
                console.log('Using short fallback list');
            });
    }

    // Form submission
    document.getElementById('institutionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate form
        if (!validateForm()) {
            return;
        }
    
        // Validate CAPTCHA
        const captchaInput = document.getElementById('captchaInput').value;
        if (!validateCaptcha(captchaInput)) {
            document.getElementById('captchaError').style.display = 'block';
            document.getElementById('captchaError').textContent = 'Please enter the correct CAPTCHA text';
            document.getElementById('captchaInput').focus();
            displayCaptcha(); // Generate new CAPTCHA
            return;
        }
        
        // Show loading, hide form
        document.getElementById('loading').style.display = 'block';
        document.getElementById('institutionForm').style.display = 'none';
        document.getElementById('submitBtn').disabled = true;
        
        // Collect form data as URL-encoded (for compatibility with e.parameter)
        const formData = new URLSearchParams();
        formData.append('institutionName', document.getElementById('institutionName').value);
        formData.append('country', document.getElementById('country').value);
        formData.append('firstName', document.getElementById('firstName').value);
        formData.append('lastName', document.getElementById('lastName').value);
        formData.append('jobTitle', document.getElementById('jobTitle').value);
        formData.append('email', document.getElementById('email').value);
        formData.append('verificationLink', document.getElementById('verificationLink').value);
        formData.append('endorsementLink', document.getElementById('endorsementLink').value);
        formData.append('additionalInfo', document.getElementById('additionalInfo').value);
        formData.append('declaration1', document.getElementById('declaration1').checked.toString());
        formData.append('declaration2', document.getElementById('declaration2').checked.toString());
        formData.append('declaration3', document.getElementById('declaration3').checked.toString());
        formData.append('timestamp', new Date().toISOString());
        formData.append('type', 'institution');
        formData.append('source', 'website_form');
        
        console.log('Submitting institution form data:', Object.fromEntries(formData));
        
        try {
            // Send data to Google Apps Script as URL-encoded
            const response = await fetch(INSTITUTION_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString()
            });
            
            console.log('Response status:', response.status);
            
            // Parse the JSON response
            const result = await response.json();
            console.log('Response result:', result);
            
            // Hide loading
            document.getElementById('loading').style.display = 'none';
            
            if (result.success) {
                // Show success message
                if (document.getElementById('declaration3').checked) {
                    try {
                        // Determine which email to use
                        let mailingListEmail = document.getElementById('subscriptionEmail').value.trim();

                        // If separate email field is empty, use institutional email
                        if (!mailingListEmail) {
                            mailingListEmail = document.getElementById('email').value.trim();
                        }

                        if (mailingListEmail) {
                            console.log('Adding to mailing list:', mailingListEmail);

                            const mailingListData = new URLSearchParams();
                            mailingListData.append('email', mailingListEmail);
                            mailingListData.append('firstName', document.getElementById('firstName').value.trim());
                            mailingListData.append('lastName', document.getElementById('lastName').value.trim());
                            mailingListData.append('institution', document.getElementById('institutionName').value.trim()); // FIXED: was 'institution'
                            mailingListData.append('country', document.getElementById('country').value);
                            mailingListData.append('jobTitle', document.getElementById('jobTitle').value.trim());
                            mailingListData.append('source', 'manifesto_signup');
                            mailingListData.append('timestamp', new Date().toISOString());

                            const mailingResponse = await fetch(ACTIVE_MEMBERS_URL, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: mailingListData.toString()
                            });

                            const mailingResult = await mailingResponse.json();
                            console.log('Mailing list response:', mailingResult);

                            if (!mailingResult.success) {
                                console.warn('Mailing list addition warning:', mailingResult.message);
                            }
                        }
                    } catch (mailingError) {
                        console.warn('Mailing list error (non-fatal):', mailingError);
                        // Don't fail the main submission
                    }
                }

                document.getElementById('successMessage').style.display = 'block';
            } else {
                throw new Error(result.message || result.error || 'Submission failed');
            }
            
        } catch (error) {
            console.error('Error:', error);
            
            // Hide loading, show error and form again
            document.getElementById('loading').style.display = 'none';
            document.getElementById('institutionForm').style.display = 'block';
            document.getElementById('submitBtn').disabled = false;
            
            // Show error message
            let errorDiv = document.getElementById('errorMessage');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'errorMessage';
                errorDiv.className = 'form-error';
                document.querySelector('.container').insertBefore(errorDiv, document.getElementById('institutionForm'));
            }
            
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
                <p><strong>Error submitting form:</strong> ${error.message}</p>
                <p>Please try again or contact us at info@slow-science.com</p>
                <button onclick="location.reload()" style="margin-top: 10px; padding: 10px 20px; background: #2c5530; color: white; border: none; border-radius: 5px; cursor: pointer;">Try Again</button>
            `;
        }
    });
    
    function validateForm() {
        let isValid = true;
        
        // Reset errors
        document.querySelectorAll('.error-message').forEach(el => {
            el.style.display = 'none';
        });
        
        // Remove any existing main error message
        const errorDiv = document.getElementById('errorMessage');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
        
        // Check required fields
        const requiredFields = [
            'institutionName', 'country', 'firstName', 'lastName', 
            'jobTitle', 'email', 'verificationLink', 'endorsementLink'
        ];
        
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                document.getElementById(`${fieldId}Error`).style.display = 'block';
                isValid = false;
            }
        });
        
        // Validate email
        const email = document.getElementById('email').value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            document.getElementById('emailError').style.display = 'block';
            document.getElementById('emailError').textContent = 'Please enter a valid email address';
            isValid = false;
        }
        
        // Subscription email validation (if provided)
        const subscriptionEmail = document.getElementById('subscriptionEmail').value;
        if (subscriptionEmail && !emailRegex.test(subscriptionEmail)) {
            document.getElementById('subscriptionEmailError').textContent = 'Please enter a valid email address';
            document.getElementById('subscriptionEmailError').style.display = 'block';
            isValid = false;
        }

        // CAPTCHA validation
        const captchaInput = document.getElementById('captchaInput').value;
        if (!captchaInput.trim()) {
            document.getElementById('captchaError').textContent = 'Please enter the CAPTCHA text';
            document.getElementById('captchaError').style.display = 'block';
            isValid = false;
        }

        // Validate URLs (simple validation)
        const verificationLink = document.getElementById('verificationLink').value;
        const endorsementLink = document.getElementById('endorsementLink').value;
        
        if (verificationLink && !isValidUrl(verificationLink)) {
            document.getElementById('verificationLinkError').style.display = 'block';
            document.getElementById('verificationLinkError').textContent = 'Please enter a valid URL';
            isValid = false;
        }
        
        if (endorsementLink && !isValidUrl(endorsementLink)) {
            document.getElementById('endorsementLinkError').style.display = 'block';
            document.getElementById('endorsementLinkError').textContent = 'Please enter a valid URL';
            isValid = false;
        }
        
        // Check declarations
        const declaration1 = document.getElementById('declaration1');
        const declaration2 = document.getElementById('declaration2');
        
        if (!declaration1.checked || !declaration2.checked) {
            alert('Please accept all required declarations.');
            isValid = false;
        }
        
        return isValid;
    }
    
    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }
    
    // Test function - you can call this from browser console to test the API
    window.testInstitutionAPI = async function() {
        const testData = new URLSearchParams();
        testData.append('institutionName', 'Test University');
        testData.append('country', 'United States');
        testData.append('firstName', 'Test');
        testData.append('lastName', 'Director');
        testData.append('jobTitle', 'Director');
        testData.append('email', 'test@example.com');
        testData.append('verificationLink', 'https://example.com/staff');
        testData.append('endorsementLink', 'https://example.com/endorsement');
        testData.append('additionalInfo', 'Test info');
        testData.append('declaration1', 'true');
        testData.append('declaration2', 'true');
        testData.append('declaration3', 'false');
        testData.append('type', 'institution');
        testData.append('source', 'test');
        
        try {
            const response = await fetch(INSTITUTION_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: testData.toString()
            });
            const result = await response.json();
            console.log('Test API result:', result);
            return result;
        } catch (error) {
            console.error('Test API error:', error);
            return { success: false, error: error.message };
        }
    };
</script>
</body>
</html>